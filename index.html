<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BMO - Receptor de Coordenadas</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; touch-action: none; }
    body { 
        background-color: #66E0D4; 
        height: 100vh; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        overflow: hidden; 
        transition: background-color 0.5s ease; 
        font-family: sans-serif; 
    }
    
    .face-svg { width: 350px; height: auto; transition: transform 0.05s; }
    
    /* Las l√≠neas de la cara con transiciones suaves para animarse */
    .stroke-line { 
        fill: none; 
        stroke: #1a1a1a; 
        stroke-width: 5; 
        stroke-linecap: round; 
        transition: d 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s; 
    }

    .eye-dot { fill: #1a1a1a; opacity: 0; transition: opacity 0.3s; }
    
    /* Boca animada para cuando habla */
    .mouth-open { 
        fill: #2d9188; 
        stroke: #1a1a1a; 
        stroke-width: 3; 
        opacity: 0; 
        transform-origin: center; 
    }

    .talking .mouth-open { opacity: 1; animation: talk 0.12s infinite alternate; }
    .talking .mouth-closed { opacity: 0; }

    @keyframes talk { 
        from { transform: scaleY(0.5); } 
        to { transform: scaleY(1.3); } 
    }

    #status { 
        position: absolute; 
        top: 10px; 
        font-size: 12px; 
        color: #000; 
        opacity: 0.5; 
        text-transform: uppercase; 
        letter-spacing: 1px; 
        padding: 5px 10px;
        background: rgba(255,255,255,0.2);
        border-radius: 10px;
    }
    
    #connection-status {
        position: absolute;
        bottom: 10px;
        right: 10px;
        font-size: 10px;
        color: #000;
        opacity: 0.3;
    }
    
    .connected { color: green !important; opacity: 0.8 !important; }
    .disconnected { color: red !important; }
</style>
</head>
<body id="mainBody">

<div id="status">Esperando conexi√≥n...</div>
<div id="connection-status" class="disconnected">Desconectado</div>

<svg id="faceSvg" class="face-svg" viewBox="0 0 200 150">
    <path id="browL" class="stroke-line" d="M45,40 L65,55" style="opacity:0" />
    <path id="browR" class="stroke-line" d="M155,40 L135,55" style="opacity:0" />

    <path id="eyeL" class="stroke-line" d="M50,65 Q60,55 70,65" />
    <path id="eyeR" class="stroke-line" d="M130,65 Q140,55 150,65" />

    <circle id="dotL" class="eye-dot" cx="60" cy="70" r="6" />
    <circle id="dotR" class="eye-dot" cx="140" cy="70" r="6" />

    <path id="mouthClosed" class="stroke-line mouth-closed" d="M75,105 Q100,115 125,105" />
    <ellipse id="mouthOpen" class="mouth-open" cx="100" cy="110" rx="25" ry="20" />
</svg>

<script>
const body = document.getElementById("mainBody");
const statusDiv = document.getElementById("status");
const connStatus = document.getElementById("connection-status");
const eyeL = document.getElementById("eyeL"), eyeR = document.getElementById("eyeR");
const dotL = document.getElementById("dotL"), dotR = document.getElementById("dotR");
const browL = document.getElementById("browL"), browR = document.getElementById("browR");
const mouthClosed = document.getElementById("mouthClosed");

// Estado de conexi√≥n
let socket = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 10;

function connectWebSocket() {
    console.log("üîó Intentando conectar a WebSocket...");
    statusDiv.innerText = "Conectando...";
    connStatus.className = "disconnected";
    connStatus.textContent = "Conectando...";
    
    // Usar localhost:8765 (el mismo que el servidor Python)
    socket = new WebSocket('ws://localhost:8765');
    
    socket.onopen = function(event) {
        console.log("‚úÖ WebSocket conectado");
        statusDiv.innerText = "Conectado a BMO";
        connStatus.className = "connected";
        connStatus.textContent = "Conectado";
        reconnectAttempts = 0;
    };
    
    socket.onmessage = function(event) {
        const data = event.data;
        console.log("üì• Recibido:", data);
        
        // Comando para dibujar: DRAW:ojoL|ojoR|boca|color|puntos(0 o 1)|cejas(0 o 1)
        if (data.startsWith("DRAW:")) {
            const parts = data.replace("DRAW:", "").split("|");
            
            if (parts.length === 6) {
                const [dEyeL, dEyeR, dMouth, bgColor, useDots, useBrows] = parts;
                
                console.log("üé≠ Aplicando expresi√≥n:", { dEyeL, dEyeR, dMouth, bgColor, useDots, useBrows });
                
                // Actualizar formas
                eyeL.setAttribute('d', dEyeL);
                eyeR.setAttribute('d', dEyeR);
                mouthClosed.setAttribute('d', dMouth);
                
                // Actualizar colores
                body.style.backgroundColor = bgColor;
                
                // Mostrar u ocultar puntos/cejas (1 = visible, 0 = oculto)
                dotL.style.opacity = useDots === "1" ? "1" : "0";
                dotR.style.opacity = useDots === "1" ? "1" : "0";
                eyeL.style.opacity = useDots === "1" ? "0" : "1";
                eyeR.style.opacity = useDots === "1" ? "0" : "1";
                
                browL.style.opacity = useBrows === "1" ? "1" : "0";
                browR.style.opacity = useBrows === "1" ? "1" : "0";
                
                statusDiv.innerText = "Expresi√≥n actualizada";
            } else {
                console.error("‚ùå Formato incorrecto:", parts);
                statusDiv.innerText = "Error en formato";
            }
        }
        
        // Comandos de habla
        if (data === "START_TALKING") {
            console.log("üó£Ô∏è BMO hablando...");
            body.classList.add("talking");
            statusDiv.innerText = "BMO hablando";
        }
        if (data === "STOP_TALKING") {
            console.log("ü§ê BMO dej√≥ de hablar");
            body.classList.remove("talking");
            statusDiv.innerText = "Listo";
        }
        
        if (data === "CONNECTED:BMO") {
            console.log("ü§ñ Conectado al servidor BMO");
            statusDiv.innerText = "Sincronizado con BMO";
        }
        
        if (data === "SHUTDOWN") {
            console.log("üîÑ BMO se est√° apagando...");
            statusDiv.innerText = "BMO apag√°ndose";
        }
    };
    
    socket.onerror = function(error) {
        console.error("‚ùå Error WebSocket:", error);
        statusDiv.innerText = "Error de conexi√≥n";
        connStatus.className = "disconnected";
        connStatus.textContent = "Error";
    };
    
    socket.onclose = function(event) {
        console.log("üîå WebSocket desconectado");
        statusDiv.innerText = "Desconectado";
        connStatus.className = "disconnected";
        connStatus.textContent = "Desconectado";
        
        // Intentar reconectar
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`üîÑ Intentando reconectar (${reconnectAttempts}/${maxReconnectAttempts})...`);
            statusDiv.innerText = `Reconectando (${reconnectAttempts})...`;
            
            setTimeout(connectWebSocket, 2000 * reconnectAttempts);
        } else {
            console.error("‚ùå M√°ximo de intentos de reconexi√≥n alcanzado");
            statusDiv.innerText = "Conexi√≥n perdida";
            connStatus.textContent = "Conexi√≥n perdida";
        }
    };
}

// Iniciar conexi√≥n cuando se carga la p√°gina
window.onload = function() {
    console.log("üåê P√°gina cargada, iniciando conexi√≥n...");
    connectWebSocket();
    
    // Tambi√©n reconectar si hay problemas de visibilidad
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && (!socket || socket.readyState === WebSocket.CLOSED)) {
            console.log("üëÄ P√°gina visible, reconectando...");
            connectWebSocket();
        }
    });
};

// Manejar errores globales
window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.error("üö® Error global:", msg, error);
    return false;
};
</script>
</body>
</html>
