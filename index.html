<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BMO Web</title>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    user-select: none;
}

body {
    background: #66E0D4;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background 0.3s;
    font-family: sans-serif;
}

#status {
    position: absolute;
    top: 10px;
    left: 10px;
    font-size: 14px;
    background: rgba(0,0,0,0.4);
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
}

.face {
    width: 300px;
}

.line {
    fill: none;
    stroke: #111;
    stroke-width: 4;
    stroke-linecap: round;
}

.mouth-open {
    fill: #2d9188;
    stroke: #111;
    stroke-width: 3;
    opacity: 0;
}

.talking .mouth-open { opacity: 1; }
.talking .mouth-closed { opacity: 0; }
</style>
</head>

<body id="body">

<div id="status">Conectando...</div>

<svg id="face" class="face" viewBox="0 0 200 150">
    <path id="eyeL" class="line" />
    <path id="eyeR" class="line" />
    <path id="mouthC" class="line mouth-closed" />
    <ellipse id="mouthO" class="mouth-open" cx="100" cy="100" rx="25" ry="20"/>
</svg>

<script>
/* =====================
   ELEMENTOS
===================== */
const body = document.getElementById("body");
const statusBox = document.getElementById("status");

const eyeL = document.getElementById("eyeL");
const eyeR = document.getElementById("eyeR");
const mouthC = document.getElementById("mouthC");

/* =====================
   WEBSOCKET
===================== */
/* âš ï¸ CAMBIA localhost POR LA IP DE TU PC SI ABRES DESDE EL TELÃ‰FONO */
const WS_URL = "ws://localhost:8765";

let ws;

function connectWS() {
    ws = new WebSocket(WS_URL);

    ws.onopen = () => {
        statusBox.textContent = "ðŸŸ¢ Conectado a BMO";
    };

    ws.onclose = () => {
        statusBox.textContent = "ðŸ”´ Desconectado. Reintentando...";
        setTimeout(connectWS, 2000);
    };

    ws.onerror = () => {
        statusBox.textContent = "âš ï¸ Error de conexiÃ³n";
    };

    ws.onmessage = e => {
        handleMessage(e.data);
    };
}

connectWS();

/* =====================
   MENSAJES
===================== */
function handleMessage(msg) {

    if (msg === "START_TALKING") {
        body.classList.add("talking");
        return;
    }

    if (msg === "STOP_TALKING") {
        body.classList.remove("talking");
        return;
    }

    if (msg.startsWith("DRAW:")) {
        drawFace(msg.substring(5));
    }
}

/* =====================
   DIBUJO
===================== */
function drawFace(data) {

    if (data === "thinking") {
        eyeL.setAttribute("d", "M50 65 Q60 55 70 65");
        eyeR.setAttribute("d", "M130 65 Q140 55 150 65");
        mouthC.setAttribute("d", "M80 110 Q100 120 120 110");
        return;
    }

    // OjoL | OjoR | Boca | Color | Puntos | Cejas
    const parts = data.split("|");
    if (parts.length < 4) return;

    eyeL.setAttribute("d", parts[0]);
    eyeR.setAttribute("d", parts[1]);
    mouthC.setAttribute("d", parts[2]);

    document.body.style.background = parts[3];
}
</script>

</body>
</html>
