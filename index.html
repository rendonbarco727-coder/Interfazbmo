<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>BMO â€“ Expresiones Inteligentes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ===== VARIABLES ===== */
:root {
    --dark:#1a1a1a;
    --bg:#66e0d1;
    --sleep:#7de8d1;
    --t:0.6s ease;
}

/* ===== BODY ===== */
body{
    margin:0;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    background:var(--bg);
    transition:background 1s ease;
    font-family:sans-serif;
}

/* ===== CANVAS ===== */
.master-canvas{
    width:500px;
    height:300px;
    position:relative;
    border-radius:30px;
    background:rgba(255,255,255,.15);
    overflow:hidden;
}

/* ===== CARAS ===== */
.face-container{
    position:absolute;
    inset:0;
    opacity:0;
    transition:opacity .4s ease;
}
.face-container.active{
    opacity:1;
}

/* ===== SVG ===== */
svg{width:100%;height:100%}
.eye-fill,.pupil,.dot{fill:var(--dark)}
.line,.mouth-line,.face-element{
    stroke:var(--dark);
    stroke-width:10;
    stroke-linecap:round;
    fill:none;
}
.m-border{fill:var(--dark)}
.m-fill-green{fill:#006338}
.m-fill-red{fill:#b90000}
.tongue{fill:#f24e32}

/* ===== SUEÃ‘O ===== */
.sleep-box{
    width:300px;height:200px;
    position:relative;
    margin:auto;
    top:50px;
}
.s-eye{
    width:45px;height:12px;
    background:var(--dark);
    border-radius:6px;
    position:absolute;top:40%;
}
.s-eye.left{left:40px}
.s-eye.right{right:40px}
.s-mouth{
    width:35px;height:35px;
    border:5px solid var(--dark);
    border-radius:50%;
    position:absolute;
    bottom:20%;left:50%;
    transform:translateX(-50%);
    animation:breathe 3s infinite;
}
.z{position:absolute;font-weight:900;opacity:0;animation:sleep 4s infinite}
.z-s{font-size:30px}
.z-l{font-size:70px;animation-delay:2s}

@keyframes breathe{
    0%,100%{transform:translateX(-50%) scale(.8)}
    50%{transform:translateX(-50%) scale(1.2)}
}
@keyframes sleep{
    0%{transform:translateY(20px);opacity:0}
    20%{opacity:1}
    100%{transform:translate(20px,-50px);opacity:0}
}
</style>
</head>

<body>

<div class="master-canvas">

<!-- === f1 Algo mal === -->
<div id="f1" class="face-container">
<svg viewBox="0 0 500 300">
<circle class="eye-fill" cx="170" cy="110" r="10"/>
<circle class="eye-fill" cx="330" cy="110" r="10"/>
<line class="mouth-line" x1="210" y1="185" x2="290" y2="170"/>
</svg>
</div>

<!-- === f2 Asombro === -->
<div id="f2" class="face-container">
<svg viewBox="0 0 500 300">
<circle class="eye-fill" cx="160" cy="100" r="10"/>
<circle class="eye-fill" cx="340" cy="100" r="10"/>
<circle cx="250" cy="180" r="25" stroke="var(--dark)" fill="none" stroke-width="8"/>
</svg>
</div>

<!-- === f3 Pensando === -->
<div id="f3" class="face-container">
<svg viewBox="0 0 500 300">
<circle class="pupil" cx="150" cy="120" r="10"/>
<circle class="pupil" cx="350" cy="120" r="10"/>
<line class="mouth-line" x1="180" y1="190" x2="320" y2="190"/>
</svg>
</div>

<!-- === f6 Molesto / Error === -->
<div id="f6" class="face-container">
<svg viewBox="0 0 500 300">
<circle class="pupil" cx="150" cy="120" r="12"/>
<circle class="pupil" cx="350" cy="120" r="12"/>
<path class="face-element" d="M200,220 Q250,150 300,220"/>
</svg>
</div>

<!-- === f8 Hablando === -->
<div id="f8" class="face-container">
<svg viewBox="0 0 500 300">
<path d="M120,130 A35,35 0 0 1 190,130" stroke="var(--dark)" fill="none" stroke-width="10"/>
<path d="M310,130 A35,35 0 0 1 380,130" stroke="var(--dark)" fill="none" stroke-width="10"/>
<g transform="translate(250,200)">
<path class="m-border" d="M-60,0 C-60,40 60,40 60,0"/>
<path class="tongue" d="M-30,20 C-10,30 10,30 30,20"/>
</g>
</svg>
</div>

<!-- === f9 Dormido === -->
<div id="f9" class="face-container">
<div class="sleep-box">
<div class="s-eye left"></div>
<div class="s-eye right"></div>
<div class="s-mouth"></div>
<div class="z z-s">z</div>
<div class="z z-l">Z</div>
</div>
</div>

</div>

<script>
let ws;
let idleTimer;
const IDLE_TIME = 15000;

function connectWS(){
    ws = new WebSocket("ws://localhost:8765");

    ws.onopen = () => {
        console.log("ðŸŸ¢ BMO conectado");
        BMO.listening();
    };

    ws.onmessage = e => {
        resetIdle();
        const data = JSON.parse(e.data);

        if(data.state === "thinking") BMO.thinking();
        if(data.state === "speaking"){
            BMO.speaking();
            speak(data.text);
        }
        if(data.state === "error") BMO.error();
    };

    ws.onclose = () => {
        console.log("ðŸ”´ WS cerrado, reintentando...");
        setTimeout(connectWS,2000);
    };
}

function sendText(text){
    ws.send(JSON.stringify({
        type:"user",
        text:text
    }));
}

function resetIdle(){
    clearTimeout(idleTimer);
    idleTimer = setTimeout(()=>{
        BMO.sleep();
    },IDLE_TIME);
}

/* ===== VOZ ===== */
function speak(text){
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "es-MX";
    u.onstart = ()=>BMO.speaking();
    u.onend = ()=>BMO.listening();
    speechSynthesis.speak(u);
}

connectWS();
</script>

</body>
</html>
